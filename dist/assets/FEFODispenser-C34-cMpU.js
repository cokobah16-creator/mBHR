import{u as C,r as i,f as d,j as e,a as I,g as E,m as T,h as $,k as U,o as L}from"./index-Cg81Mk6P.js";function _({patientId:y,visitId:q,onSuccess:h,onCancel:p}){C();const[f,k]=i.useState([]),[x,b]=i.useState([]),[c,M]=i.useState(""),[r,g]=i.useState(1),[l,j]=i.useState([]),[m,S]=i.useState(""),[u,O]=i.useState(""),[N,v]=i.useState(!1);i.useEffect(()=>{B()},[]),i.useEffect(()=>{c&&H(c)},[c]),i.useEffect(()=>{c&&r>0&&Q()},[c,r,x]);const B=async()=>{try{const t=await d.inventory.where("onHandQty").above(0).toArray();k(t)}catch(t){console.error("Error loading medications:",t)}},H=async t=>{try{const n=await d.stockBatches.where("drugId").equals(t).and(s=>s.qtyOnHand>0).toArray();b(n)}catch(n){console.error("Error loading batches:",n),b([])}},Q=()=>{if(!x.length||r<=0){j([]);return}const t=[...x].sort((a,o)=>new Date(a.expiryDate).getTime()-new Date(o.expiryDate).getTime()),n=[];let s=r;for(const a of t){if(s<=0)break;const o=Math.min(a.qtyOnHand,s);n.push({batchId:a.id,lotNumber:a.lotNumber,qty:o,expiryDate:a.expiryDate}),s-=o}j(n)},R=t=>{const n=new Date,s=new Date(t),a=Math.ceil((s.getTime()-n.getTime())/(1e3*60*60*24));return a<0?{status:"expired",color:"text-red-600 bg-red-50",icon:T}:a<=30?{status:"expiring",color:"text-yellow-600 bg-yellow-50",icon:E}:a<=90?{status:"warning",color:"text-orange-600 bg-orange-50",icon:$}:{status:"good",color:"text-green-600 bg-green-50",icon:U}},w=()=>c&&r>0&&l.length>0&&l.reduce((t,n)=>t+n.qty,0)>=r&&m.trim()&&u.trim(),A=async()=>{if(w()){v(!0);try{const t=f.find(s=>s.id===c);if(!t)throw new Error("Medication not found");const n={id:crypto.randomUUID(),patientId:y,visitId:q,itemName:t.itemName,qty:r,dosage:m,directions:u,dispensedBy:"Pharmacist",dispensedAt:new Date,_dirty:1};await d.dispenses.add(n);for(const s of l){const a=x.find(o=>o.id===s.batchId);a&&await d.stockBatches.update(s.batchId,{qtyOnHand:a.qtyOnHand-s.qty})}await d.inventory.update(c,{onHandQty:t.onHandQty-r,updatedAt:new Date});try{const s=L(),a=new Date;a.setDate(a.getDate()+1),a.setHours(9,0,0,0),await s.queueMedicationReminder(y,t.itemName,m,u,a)}catch(s){console.warn("Failed to queue reminder:",s)}h==null||h()}catch(t){console.error("Error dispensing medication:",t),alert("Failed to dispense medication")}finally{v(!1)}}},D=l.reduce((t,n)=>t+n.qty,0),F=D<r;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(I,{className:"h-8 w-8 text-primary"}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"FEFO Medication Dispense"}),e.jsx("p",{className:"text-gray-600",children:"First Expired, First Out - automatic batch selection"})]})]}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-lg font-medium text-gray-700 mb-3",children:"Medication *"}),e.jsxs("select",{value:c,onChange:t=>M(t.target.value),className:"input-field text-lg",children:[e.jsx("option",{value:"",children:"Select medication"}),f.map(t=>e.jsxs("option",{value:t.id,children:[t.itemName," (",t.onHandQty," ",t.unit," available)"]},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-lg font-medium text-gray-700 mb-3",children:"Quantity *"}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("button",{type:"button",onClick:()=>g(Math.max(1,r-1)),className:"w-12 h-12 bg-red-100 text-red-600 rounded-full flex items-center justify-center hover:bg-red-200 touch-target-large",children:e.jsx("span",{className:"text-xl font-bold",children:"−"})}),e.jsx("div",{className:"text-center",children:e.jsx("input",{type:"number",value:r,onChange:t=>g(Math.max(1,parseInt(t.target.value)||1)),min:"1",className:"w-20 text-2xl font-bold text-center border-2 border-gray-300 rounded-lg py-2"})}),e.jsx("button",{type:"button",onClick:()=>g(r+1),className:"w-12 h-12 bg-green-100 text-green-600 rounded-full flex items-center justify-center hover:bg-green-200 touch-target-large",children:e.jsx("span",{className:"text-xl font-bold",children:"+"})})]})]}),l.length>0&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium text-gray-700 mb-3",children:"Batch Allocation (FEFO Order)"}),F&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 mb-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(E,{className:"h-5 w-5 text-red-600"}),e.jsxs("span",{className:"text-sm text-red-800",children:["Insufficient stock: ",D," available, ",r," requested"]})]})}),e.jsx("div",{className:"space-y-3",children:l.map((t,n)=>{const s=R(t.expiryDate),a=s.icon;return e.jsx("div",{className:"border rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium text-gray-900",children:["Batch ",n+1,": ",t.lotNumber]}),e.jsxs("div",{className:"text-sm text-gray-600",children:["Quantity: ",t.qty," • Expires: ",new Date(t.expiryDate).toLocaleDateString()]})]}),e.jsxs("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${s.color}`,children:[e.jsx(a,{className:"h-3 w-3 mr-1"}),s.status]})]})},t.batchId)})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-lg font-medium text-gray-700 mb-3",children:"Dosage *"}),e.jsx("input",{type:"text",value:m,onChange:t=>S(t.target.value),className:"input-field text-lg",placeholder:"e.g., 1 tablet, 5ml"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-lg font-medium text-gray-700 mb-3",children:"Directions *"}),e.jsx("textarea",{value:u,onChange:t=>O(t.target.value),className:"input-field text-lg",rows:3,placeholder:"Take twice daily with food"})]})]}),e.jsxs("div",{className:"flex space-x-4 pt-6",children:[e.jsx("button",{onClick:A,disabled:!w()||N||F,className:"btn-primary flex-1 disabled:opacity-50 disabled:cursor-not-allowed",children:N?"Dispensing...":"Dispense & Set Reminder"}),p&&e.jsx("button",{onClick:p,className:"btn-secondary",children:"Cancel"})]})]})})]})}export{_ as default};
