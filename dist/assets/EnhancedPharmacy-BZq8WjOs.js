import{r as n,u as re,d as ne,p as ie,j as e,g as E,f as p,k as H,a as ce,m as O,h as le,n as de,o as oe}from"./index-Cg81Mk6P.js";function me({title:d,titleId:u,...h},g){return n.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:g,"aria-labelledby":u},h),d?n.createElement("title",{id:u},d):null,n.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z"}))}const Q=n.forwardRef(me);function xe({title:d,titleId:u,...h},g){return n.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:g,"aria-labelledby":u},h),d?n.createElement("title",{id:u},d):null,n.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 9v3.75m0-10.036A11.959 11.959 0 0 1 3.598 6 11.99 11.99 0 0 0 3 9.75c0 5.592 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.57-.598-3.75h-.152c-3.196 0-6.1-1.25-8.25-3.286Zm0 13.036h.008v.008H12v-.008Z"}))}const $=n.forwardRef(xe);function pe({patientId:d,visitId:u,onSuccess:h,onCancel:g}){var L;const{t:l}=re(),{currentUser:y}=ne(),[j,P]=n.useState([]),[N,k]=n.useState([]),[c,T]=n.useState(""),[i,D]=n.useState(1),[m,M]=n.useState([]),[f,U]=n.useState(""),[b,Z]=n.useState(""),[ue,W]=n.useState([]),[v,_]=n.useState([]),[w,S]=n.useState([]),[A,I]=n.useState(!1),[V,q]=n.useState(!1),z=[{drug1:"Warfarin",drug2:"Aspirin",severity:"major",description:"Increased bleeding risk",action:"Monitor INR closely, consider alternative"},{drug1:"ACE Inhibitor",drug2:"Potassium",severity:"moderate",description:"Risk of hyperkalemia",action:"Monitor potassium levels"},{drug1:"NSAID",drug2:"ACE Inhibitor",severity:"moderate",description:"Reduced antihypertensive effect",action:"Monitor blood pressure"}];if(!y||!ie(y.role,"dispense"))return e.jsxs("div",{className:"text-center py-12",children:[e.jsx(E,{className:"h-12 w-12 mx-auto text-gray-400 mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Access Restricted"}),e.jsx("p",{className:"text-gray-600",children:"Only pharmacists and administrators can access enhanced pharmacy features."})]});n.useEffect(()=>{G()},[]),n.useEffect(()=>{c&&(J(c),X())},[c,v]),n.useEffect(()=>{c&&i>0&&K()},[c,i,N]);const G=async()=>{try{const[t,r,s]=await Promise.all([p.inventory.where("onHandQty").above(0).toArray(),p.patients.get(d),p.dispenses.where("patientId").equals(d).reverse().limit(10).toArray()]);P(t);const a=new Date;a.setDate(a.getDate()-30);const o=s.filter(x=>x.dispensedAt>a).map(x=>x.itemName);_([...new Set(o)]),W([])}catch(t){console.error("Error loading pharmacy data:",t)}},J=async t=>{try{const r=await p.stockBatches.where("drugId").equals(t).and(s=>s.qtyOnHand>0).toArray();k(r)}catch(r){console.error("Error loading batches:",r),k([])}},K=()=>{if(!N.length||i<=0){M([]);return}const t=[...N].sort((a,o)=>new Date(a.expiryDate).getTime()-new Date(o.expiryDate).getTime()),r=[];let s=i;for(const a of t){if(s<=0)break;const o=Math.min(a.qtyOnHand,s),x=Math.ceil((new Date(a.expiryDate).getTime()-new Date().getTime())/(1e3*60*60*24));r.push({batchId:a.id,lotNumber:a.lotNumber,qty:o,expiryDate:a.expiryDate,daysUntilExpiry:x}),s-=o}M(r)},X=()=>{if(!c){S([]);return}const t=j.find(s=>s.id===c);if(!t)return;const r=z.filter(s=>{const a=t.itemName.toLowerCase();return v.some(o=>{const x=o.toLowerCase();return s.drug1.toLowerCase().includes(a.split(" ")[0])&&s.drug2.toLowerCase().includes(x.split(" ")[0])||s.drug2.toLowerCase().includes(a.split(" ")[0])&&s.drug1.toLowerCase().includes(x.split(" ")[0])})});S(r)},Y=t=>t<0?{status:"expired",color:"text-red-600 bg-red-50",icon:O}:t<=30?{status:"expiring",color:"text-yellow-600 bg-yellow-50",icon:E}:t<=90?{status:"warning",color:"text-orange-600 bg-orange-50",icon:le}:{status:"good",color:"text-green-600 bg-green-50",icon:H},ee=t=>{switch(t){case"major":return"bg-red-100 text-red-800 border-red-200";case"moderate":return"bg-yellow-100 text-yellow-800 border-yellow-200";case"minor":return"bg-blue-100 text-blue-800 border-blue-200"}},R=()=>{const t=m.some(s=>s.daysUntilExpiry<0),r=w.some(s=>s.severity==="major");return c&&i>0&&m.length>0&&m.reduce((s,a)=>s+a.qty,0)>=i&&f.trim()&&b.trim()&&!t&&!r},te=async()=>{if(R()){I(!0);try{const t=j.find(s=>s.id===c);if(!t)throw new Error("Medication not found");const r={id:de(),patientId:d,visitId:u,itemName:t.itemName,qty:i,dosage:f,directions:b,dispensedBy:(y==null?void 0:y.fullName)||"Unknown",dispensedAt:new Date,_dirty:1};await p.dispenses.add(r);for(const s of m){const a=N.find(o=>o.id===s.batchId);a&&await p.stockBatches.update(s.batchId,{qtyOnHand:a.qtyOnHand-s.qty})}await p.inventory.update(c,{onHandQty:t.onHandQty-i,updatedAt:new Date});try{const s=oe(),a=new Date;a.setDate(a.getDate()+1),a.setHours(9,0,0,0),await s.queueMedicationReminder(d,t.itemName,f,b,a)}catch(s){console.warn("Failed to queue reminder:",s)}q(!0)}catch(t){console.error("Error dispensing medication:",t),alert(l("error.dispenseFailed"))}finally{I(!1)}}},se=()=>{q(!1),h==null||h()};if(V)return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Q,{className:"h-8 w-8 text-primary"}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"Patient Counseling"}),e.jsx("p",{className:"text-gray-600",children:"Review medication instructions with patient"})]})]}),e.jsx("div",{className:"card max-w-2xl mx-auto",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsx("h3",{className:"font-medium text-blue-800 mb-2",children:"Medication Dispensed"}),e.jsxs("p",{className:"text-blue-700",children:[e.jsx("strong",{children:(L=j.find(t=>t.id===c))==null?void 0:L.itemName})," × ",i]}),e.jsxs("p",{className:"text-blue-700",children:[e.jsx("strong",{children:"Dosage:"})," ",f]}),e.jsxs("p",{className:"text-blue-700",children:[e.jsx("strong",{children:"Instructions:"})," ",b]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Counseling Checklist"}),e.jsx("div",{className:"space-y-3",children:["Explained how to take the medication","Reviewed dosage and timing","Discussed potential side effects","Confirmed patient understanding","Provided written instructions","Scheduled follow-up reminder"].map((t,r)=>e.jsxs("label",{className:"flex items-center space-x-3",children:[e.jsx("input",{type:"checkbox",className:"h-5 w-5 text-primary focus:ring-primary border-gray-300 rounded"}),e.jsx("span",{className:"text-gray-700",children:t})]},r))})]}),e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(H,{className:"h-5 w-5 text-green-600"}),e.jsx("span",{className:"text-green-800 font-medium",children:"SMS reminder scheduled for tomorrow at 9:00 AM"})]})}),e.jsx("button",{onClick:se,className:"btn-primary w-full",children:"Complete Dispensing"})]})})]});const F=m.reduce((t,r)=>t+r.qty,0),ae=F<i,C=m.some(t=>t.daysUntilExpiry<0),B=w.some(t=>t.severity==="major");return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(ce,{className:"h-8 w-8 text-primary"}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"Enhanced Pharmacy"}),e.jsx("p",{className:"text-gray-600",children:"FEFO dispensing with interaction checking"})]})]}),v.length>0&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(Q,{className:"h-5 w-5 text-blue-600"}),e.jsx("h3",{className:"font-medium text-blue-800",children:"Current Medications"})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:v.map((t,r)=>e.jsx("span",{className:"px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-sm",children:t},r))})]}),w.length>0&&e.jsx("div",{className:"space-y-3",children:w.map((t,r)=>e.jsxs("div",{className:`border rounded-lg p-4 ${ee(t.severity)}`,children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx($,{className:"h-5 w-5"}),e.jsxs("h3",{className:"font-medium",children:[t.severity.toUpperCase()," Drug Interaction"]})]}),e.jsx("p",{className:"text-sm mb-2",children:t.description}),e.jsxs("p",{className:"text-sm font-medium",children:["Action: ",t.action]})]},r))}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-lg font-medium text-gray-700 mb-3",children:[l("pharmacy.medication")," *"]}),e.jsxs("select",{value:c,onChange:t=>T(t.target.value),className:"input-field text-lg",children:[e.jsx("option",{value:"",children:l("simple.selectMedication")}),j.map(t=>e.jsxs("option",{value:t.id,children:[t.itemName," (",t.onHandQty," ",t.unit," ",l("common.available"),")"]},t.id))]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-lg font-medium text-gray-700 mb-3",children:[l("pharmacy.quantity")," *"]}),e.jsxs("div",{className:"flex items-center justify-center space-x-4",children:[e.jsx("button",{type:"button",onClick:()=>D(Math.max(1,i-1)),className:"w-12 h-12 bg-red-100 text-red-600 rounded-full flex items-center justify-center hover:bg-red-200 touch-target-large",children:e.jsx("span",{className:"text-xl font-bold",children:"−"})}),e.jsxs("div",{className:"text-center",children:[e.jsx("input",{type:"number",value:i,onChange:t=>D(Math.max(1,parseInt(t.target.value)||1)),min:"1",className:"w-24 text-3xl font-bold text-center border-2 border-gray-300 rounded-lg py-2"}),i<=10&&e.jsx("div",{className:"flex justify-center gap-1 mt-2",children:Array.from({length:i},(t,r)=>e.jsx("div",{className:"w-3 h-3 bg-primary rounded-full"},r))})]}),e.jsx("button",{type:"button",onClick:()=>D(i+1),className:"w-12 h-12 bg-green-100 text-green-600 rounded-full flex items-center justify-center hover:bg-green-200 touch-target-large",children:e.jsx("span",{className:"text-xl font-bold",children:"+"})})]})]}),m.length>0&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium text-gray-700 mb-3",children:"FEFO Batch Allocation"}),ae&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 mb-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(E,{className:"h-5 w-5 text-red-600"}),e.jsxs("span",{className:"text-sm text-red-800",children:["Insufficient stock: ",F," available, ",i," requested"]})]})}),C&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 mb-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(O,{className:"h-5 w-5 text-red-600"}),e.jsx("span",{className:"text-sm text-red-800",children:"Cannot dispense: Some batches have expired"})]})}),e.jsx("div",{className:"space-y-3",children:m.map((t,r)=>{const s=Y(t.daysUntilExpiry),a=s.icon;return e.jsx("div",{className:"border rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium text-gray-900",children:["Batch ",r+1,": ",t.lotNumber]}),e.jsxs("div",{className:"text-sm text-gray-600",children:["Quantity: ",t.qty," • Expires: ",new Date(t.expiryDate).toLocaleDateString(),"(",t.daysUntilExpiry," days)"]})]}),e.jsxs("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${s.color}`,children:[e.jsx(a,{className:"h-3 w-3 mr-1"}),s.status]})]})},t.batchId)})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-lg font-medium text-gray-700 mb-3",children:[l("pharmacy.dosage")," *"]}),e.jsx("input",{type:"text",value:f,onChange:t=>U(t.target.value),className:"input-field text-lg",placeholder:l("simple.dosageExample")})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-lg font-medium text-gray-700 mb-3",children:[l("pharmacy.directions")," *"]}),e.jsx("textarea",{value:b,onChange:t=>Z(t.target.value),className:"input-field text-lg",rows:3,placeholder:l("simple.directionsExample")})]})]}),(C||B)&&e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx($,{className:"h-5 w-5 text-red-600"}),e.jsx("h3",{className:"font-medium text-red-800",children:"Safety Alert"})]}),e.jsxs("ul",{className:"text-sm text-red-700 space-y-1",children:[C&&e.jsx("li",{children:"• Cannot dispense expired medication"}),B&&e.jsx("li",{children:"• Major drug interaction detected"})]})]}),e.jsxs("div",{className:"flex space-x-4 pt-6",children:[e.jsx("button",{onClick:te,disabled:!R()||A,className:"btn-primary flex-1 disabled:opacity-50 disabled:cursor-not-allowed",children:A?l("pharmacy.dispensing"):"Dispense & Counsel"}),g&&e.jsx("button",{onClick:g,className:"btn-secondary",children:l("action.cancel")})]})]})})]})}export{pe as default};
